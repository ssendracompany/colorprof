---
import '@/styles/components/contact.css';
import Toast from './Toast.astro';

const serviceTypes = [
  'Pintura Interior',
  'Pintura Exterior',
  'Decoración Personalizada',
  'Otro'
];
---

<section id="contacto" class="contact">
  <div class="container">
    <div class="contact-content">
      <form class="contact-form" name="contact-form" method="POST" action="https://formsubmit.co/info@colorprof.es" aria-label="Formulario de Contacto Profesional">
        <h2 class="form-title">Contáctanos para tu Proyecto</h2>

        <div class="form-group">
          <label for="name" class="form-label">Nombre Completo <span class="required-star">*</span></label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-input"
            placeholder="Ej: Juan Pérez"
            required
            aria-required="true"
          />
        </div>

        <div class="form-group">
          <label for="email" class="form-label">Correo Electrónico <span class="required-star">*</span></label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-input"
            placeholder="tu.email@ejemplo.com"
            required
            aria-required="true"
          />
          <!-- Campo oculto para configurar reply-to en FormSubmit.co -->
          <input type="hidden" name="_replyto" id="email-replyto" />
        </div>

        <div class="form-group">
          <label for="phone" class="form-label">Teléfono (Opcional)</label>
          <input
            type="tel"
            id="phone"
            name="phone"
            class="form-input"
            placeholder="Ej: 600 123 456"
          />
        </div>

        <div class="form-group">
          <label for="service" class="form-label">Tipo de Servicio</label>
          <div class="select-wrapper">
            <select
              id="service"
              name="service"
              class="form-input form-select"
            >
              <option value="Pintura Interior">Pintura Interior</option>
              <option value="Pintura Exterior">Pintura Exterior</option>
              <option value="Decoración">Decoración</option>
              <option value="Otro">Otro</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="message" class="form-label">Mensaje / Detalles del Proyecto <span class="required-star">*</span></label>
          <textarea
            id="message"
            name="message"
            class="form-input"
            rows="4"
            placeholder="Describe brevemente lo que necesitas..."
            required
            aria-required="true"
          ></textarea>
        </div>

        <!-- FormSubmit Configuration (hidden fields) -->
        <input type="hidden" name="_captcha" value="false" />
        <input type="hidden" name="_next" value="https://colorprof.es/" />
        <input type="hidden" name="_subject" value="Nuevo contacto: Colorprof" />

        <!-- Honeypot anti-spam field (hidden from users) -->
        <div class="form-group form-group--honeypot">
          <label for="honeypot" class="form-label">Website</label>
          <input
            type="text"
            id="honeypot"
            name="_honeypot"
            class="form-input"
            tabindex="-1"
            autocomplete="off"
            aria-hidden="true"
            style="display: none;"
          />
        </div>

        <button type="submit" class="submit-button">
          Enviar Solicitud
        </button>
      </form>

      <div class="contact-info">
        <div class="info-item">
          <h3 class="info-title">Teléfono</h3>
          <p class="info-content">
            <a href="tel:+34638943962">(+34) 638 94 39 62</a>
          </p>
        </div>

        <div class="info-item">
          <h3 class="info-title">Email</h3>
          <p class="info-content">
            <a href="mailto:info@colorprof.es">
              info@colorprof.es
            </a>
          </p>
        </div>

        <div class="info-item">
          <h3 class="info-title">Disponibilidad</h3>
          <p class="info-content">
            Lunes a Viernes: 9:00 - 18:00<br />
            Sábado: 10:00 - 14:00<br />
            Domingo: Cerrado
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<Toast />

<script>
  import { validateContactForm } from '../utils/contactFormValidation';
  import type { z } from 'zod';

  let hasAttemptedSubmit = false;
  const validatedFields = new Set<string>();

  const form = document.querySelector('.contact-form') as HTMLFormElement;
  const submitButton = form?.querySelector('.submit-button') as HTMLButtonElement;
  const honeypotField = form?.querySelector('[name="_honeypot"]') as HTMLInputElement;

  type FieldErrors = Record<string, string>;

  function getFormData(): Record<string, string> {
    const formData = new FormData(form);
    return {
      nombre: formData.get('name') as string || '',
      email: formData.get('email') as string || '',
      telefono: formData.get('phone') as string || '',
      servicio: formData.get('service') as string || '',
      mensaje: formData.get('message') as string || ''
    };
  }

  function syncEmailToReplyTo(): void {
    const emailField = form.querySelector('#email') as HTMLInputElement;
    const replyToField = form.querySelector('#email-replyto') as HTMLInputElement;

    if (emailField && replyToField) {
      emailField.addEventListener('input', () => {
        replyToField.value = emailField.value;
      });
    }
  }

  function showFieldError(fieldName: string, message: string): void {
    const fieldMap: Record<string, string> = {
      nombre: 'name',
      email: 'email',
      telefono: 'phone',
      servicio: 'service',
      mensaje: 'message'
    };

    const fieldId = fieldMap[fieldName];
    if (!fieldId) return;

    const field = form.querySelector(`#${fieldId}`) as HTMLInputElement;
    const formGroup = field?.closest('.form-group');

    if (!field || !formGroup) return;

    clearFieldError(fieldId);

    field.classList.add('form-input--error');
    field.setAttribute('aria-invalid', 'true');

    formGroup.classList.add('form-group--error');

    const errorId = `${fieldId}-error`;
    const errorMessage = document.createElement('span');
    errorMessage.id = errorId;
    errorMessage.className = 'form-error-message';
    errorMessage.setAttribute('role', 'alert');
    errorMessage.textContent = message;

    field.setAttribute('aria-describedby', errorId);
    formGroup.appendChild(errorMessage);
  }

  function clearFieldError(fieldId: string): void {
    const field = form.querySelector(`#${fieldId}`) as HTMLInputElement;
    const formGroup = field?.closest('.form-group');
    const existingError = formGroup?.querySelector('.form-error-message');

    if (field) {
      field.classList.remove('form-input--error');
      field.classList.remove('form-input--valid');
      field.removeAttribute('aria-invalid');
      field.removeAttribute('aria-describedby');
    }

    if (formGroup) {
      formGroup.classList.remove('form-group--error');
    }

    if (existingError) {
      existingError.remove();
    }
  }

  function clearAllErrors(): void {
    const fieldIds = ['name', 'email', 'phone', 'service', 'message'];
    fieldIds.forEach(clearFieldError);
  }

  function displayErrors(errors: z.ZodError): void {
    const fieldErrors: FieldErrors = {};

    errors.errors.forEach(error => {
      const fieldName = error.path[0] as string;
      if (!fieldErrors[fieldName]) {
        fieldErrors[fieldName] = error.message;
      }
    });

    Object.entries(fieldErrors).forEach(([fieldName, message]) => {
      showFieldError(fieldName, message);
    });

    const firstErrorField = form.querySelector('[aria-invalid="true"]') as HTMLInputElement;
    firstErrorField?.focus();
  }

  function validateField(fieldId: string): boolean {
    const formData = getFormData();
    const result = validateContactForm(formData);

    const schemaFieldMap: Record<string, string> = {
      name: 'nombre',
      email: 'email',
      phone: 'telefono',
      service: 'servicio',
      message: 'mensaje'
    };

    const schemaFieldName = schemaFieldMap[fieldId];
    if (!schemaFieldName) return true;

    clearFieldError(fieldId);

    if (!result.success) {
      const fieldError = result.error.errors.find(
        err => err.path[0] === schemaFieldName
      );

      if (fieldError) {
        showFieldError(schemaFieldName, fieldError.message);
        return false;
      }
    }

    const field = form.querySelector(`#${fieldId}`) as HTMLInputElement;
    if (field && validatedFields.has(fieldId)) {
      field.classList.add('form-input--valid');
    }

    return true;
  }

  async function handleSubmit(e: Event): Promise<void> {
    e.preventDefault();

    if (honeypotField && honeypotField.value) {
      console.log('Honeypot filled - spam detected, preventing submission');
      return;
    }

    hasAttemptedSubmit = true;
    clearAllErrors();

    const formData = getFormData();
    const result = validateContactForm(formData);

    if (!result.success) {
      displayErrors(result.error);
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = 'Enviando...';

    try {
      const formDataObj = new FormData(form);
      const formDataJson: Record<string, string> = {};

      formDataObj.forEach((value, key) => {
        formDataJson[key] = value.toString();
      });

      const response = await fetch('https://formsubmit.co/ajax/info@colorprof.es', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(formDataJson)
      });

      const data = await response.json();
      console.log('Response:', data);

      if (response.ok && data.success) {
        (window as any).showToast('¡Mensaje enviado correctamente!', 'success');
        form.reset();
        validatedFields.clear();
        hasAttemptedSubmit = false;
      } else {
        console.error('Response error:', data);
        (window as any).showToast('Error al enviar el mensaje. Por favor, inténtalo de nuevo.', 'error');
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      (window as any).showToast('Error al enviar el mensaje. Por favor, inténtalo de nuevo.', 'error');
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = 'Enviar Solicitud';
    }
  }

  function handleFieldBlur(e: Event): void {
    const fieldId = (e.target as HTMLElement).id;
    validatedFields.add(fieldId);
    validateField(fieldId);
  }

  function handleFieldInput(e: Event): void {
    const fieldId = (e.target as HTMLElement).id;

    if (validatedFields.has(fieldId)) {
      validateField(fieldId);
    }
  }

  function initFormValidation(): void {
    if (!form) return;

    syncEmailToReplyTo();
    form.addEventListener('submit', handleSubmit);

    const fields = ['name', 'email', 'phone', 'service', 'message'];
    fields.forEach(fieldId => {
      const field = form.querySelector(`#${fieldId}`);
      field?.addEventListener('blur', handleFieldBlur);
      field?.addEventListener('input', handleFieldInput);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFormValidation);
  } else {
    initFormValidation();
  }
</script>
